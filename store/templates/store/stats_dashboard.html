{% extends 'store/base.html' %}
{% load humanize %}
{% block title %}Аналітика{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <p class="page-subtitle text-uppercase mb-1">Звіти</p>
        <h2 class="page-title">Аналітика</h2>
    </div>
    <div class="d-flex align-items-center gap-2">
        <span class="badge bg-primary">{{ today }}</span>
        <span class="badge bg-dark text-white">{{ user.username }}</span>
    </div>
</div>

{% include 'store/partials/manager_nav.html' %}

<div class="row g-3 mb-3">
    <div class="col-md-3">
        <div class="card stat-card bg-success text-white card-hover">
            <div class="card-body">
                <div class="stat-label">Продажі сьогодні</div>
                <div class="stat-value">{{ today_sales|floatformat:2|intcomma }} ₴</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-info text-white card-hover">
            <div class="card-body">
                <div class="stat-label">Прибуток сьогодні</div>
                <div class="stat-value">{{ today_profit|floatformat:2|intcomma }} ₴</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-warning text-white card-hover">
            <div class="card-body">
                <div class="stat-label">Замовлення</div>
                <div class="stat-value">{{ today_orders }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-secondary text-white card-hover">
            <div class="card-body">
                <div class="stat-label">Середній чек</div>
                <div class="stat-value">{{ today_avg_check|floatformat:2|intcomma }} ₴</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-3">
    <div class="col-md-3">
        <div class="card stat-card card-hover">
            <div class="card-body">
                <div class="text-muted text-uppercase small">Продажі всього</div>
                <div class="stat-value text-success">{{ total_sales|floatformat:2|intcomma }} ₴</div>
                <small class="text-muted">{{ total_orders|intcomma }} замовл.</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card card-hover">
            <div class="card-body">
                <div class="text-muted text-uppercase small">Прибуток всього</div>
                <div class="stat-value text-info">{{ total_profit|floatformat:2|intcomma }} ₴</div>
                <small class="text-muted">{{ total_orders|intcomma }} замовл.</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card card-hover">
            <div class="card-body">
                <div class="text-muted text-uppercase small">Асортимент</div>
                <div class="stat-value text-primary">{{ total_products|intcomma }}</div>
                <small class="text-muted">Вартість складу: {{ total_stock_value|floatformat:2|intcomma }} ₴</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card card-hover">
            <div class="card-body">
                <div class="text-muted text-uppercase small">Постачальники</div>
                <div class="stat-value text-warning">{{ supplier_count }}</div>
                <small class="text-muted">Активні: {{ suppliers_active }}</small>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-3">
    <div class="col-md-4">
        <div class="card stat-card bg-danger text-white card-hover">
            <div class="card-body">
                <div class="stat-label">Повернення сьогодні</div>
                <div class="stat-value">{{ returns_today_refund|floatformat:2|intcomma }} ₴</div>
                <small class="text-white-75">Кількість: {{ returns_today_count }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card bg-danger text-white card-hover">
            <div class="card-body">
                <div class="stat-label">Повернення всього</div>
                <div class="stat-value">{{ returns_total_refund|floatformat:2|intcomma }} ₴</div>
                <small class="text-white-75">Кількість: {{ returns_count }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card bg-warning text-white card-hover">
            <div class="card-body">
                <div class="stat-label">Втрати від прострочки ({{ soon_days }} днів)</div>
                <div class="stat-value">{{ potential_expiry_loss|floatformat:2|intcomma }} ₴</div>
                <small class="text-white-75">Рахуємо потенційне списання</small>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-3">
    <div class="col-lg-6">
        <div class="card card-hover h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Стан складу</h5>
            </div>
            <div class="card-body">
                <div class="row text-center g-3">
                    <div class="col-4">
                        <small class="text-muted d-block">Низькі залишки</small>
                        <h3 class="text-danger mb-0">{{ low_stock }}</h3>
                    </div>
                    <div class="col-4">
                        <small class="text-muted d-block">Немає в наявності</small>
                        <h3 class="text-danger mb-0">{{ out_of_stock }}</h3>
                    </div>
                    <div class="col-4">
                        <small class="text-muted d-block">Ок</small>
                        <h3 class="text-success mb-0">{{ good_stock }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card card-hover h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Статус закупівель</h5>
            </div>
            <div class="card-body">
                <div class="row text-center g-3">
                    <div class="col-3">
                        <small class="text-muted d-block">Чернетка</small>
                        <h4 class="text-warning mb-0">{{ purchases_draft }}</h4>
                    </div>
                    <div class="col-3">
                        <small class="text-muted d-block">Замовлено</small>
                        <h4 class="text-info mb-0">{{ purchases_ordered }}</h4>
                    </div>
                    <div class="col-3">
                        <small class="text-muted d-block">Отримано</small>
                        <h4 class="text-success mb-0">{{ purchases_received }}</h4>
                    </div>
                    <div class="col-3">
                        <small class="text-muted d-block">Скасовано</small>
                        <h4 class="text-danger mb-0">{{ purchases_cancelled }}</h4>
                    </div>
                </div>
                <hr class="my-3">
                <div class="text-center">
                    <strong>Усього закупівель:</strong> <span class="badge bg-primary">{{ purchases_total }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

{% if top_products %}
<div class="row g-3 mb-3">
    <div class="col-md-6">
        <div class="card card-hover h-100">
            <div class="card-header">
                <h5 class="mb-0">Топ товари (дохід)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0 align-middle">
                        <thead>
                        <tr>
                            <th>Товар</th>
                            <th class="text-center">Шт.</th>
                            <th class="text-end">Дохід</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for item in top_products %}
                            <tr>
                                <td class="text-truncate" style="max-width: 250px;" title="{{ item.product__name }}">{{ item.product__name }}</td>
                                <td class="text-center">{{ item.qty_sold|floatformat:0|intcomma }}</td>
                                <td class="text-end">{{ item.revenue|floatformat:2|intcomma }} ₴</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card card-hover h-100">
            <div class="card-header">
                <h5 class="mb-0">Топ категорії (дохід)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0 align-middle">
                        <thead>
                        <tr>
                            <th>Категорія</th>
                            <th class="text-center">Шт.</th>
                            <th class="text-end">Дохід</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for item in top_categories %}
                            <tr>
                                <td>{{ item.product__category__name }}</td>
                                <td class="text-center">{{ item.qty|floatformat:0|intcomma }}</td>
                                <td class="text-end">{{ item.revenue|floatformat:2|intcomma }} ₴</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="card stat-card card-hover h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Продажі за 30 днів</h5>
            </div>
            <div class="card-body">
                <canvas id="salesChart" style="max-height: 320px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card stat-card card-hover h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Продажі за категоріями</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" style="max-height: 320px;"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card stat-card card-hover mb-3">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">Прибуток за 30 днів</h5>
    </div>
    <div class="card-body">
        <canvas id="profitChart" style="max-height: 260px;"></canvas>
    </div>
</div>

<div class="text-center text-muted small">Дані станом на {{ today }}</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const colors = {
        primary: 'rgba(37, 99, 235, 0.85)',
        primaryLight: 'rgba(37, 99, 235, 0.12)',
        success: 'rgba(16, 185, 129, 0.85)',
        successLight: 'rgba(16, 185, 129, 0.12)',
        info: 'rgba(6, 182, 212, 0.85)',
        warning: 'rgba(245, 158, 11, 0.85)',
        danger: 'rgba(239, 68, 68, 0.85)',
        purple: 'rgba(124, 58, 237, 0.85)',
    };

    fetch('{% url "api_sales_chart_data" %}')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('salesChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Продажі (₴)',
                        data: data.data,
                        borderColor: colors.primary,
                        backgroundColor: colors.primaryLight,
                        fill: true,
                        tension: 0.35,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} ₴`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' ₴';
                                }
                            }
                        }
                    }
                }
            });
        });

    fetch('{% url "api_category_chart_data" %}')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: [
                            colors.primary,
                            colors.success,
                            colors.warning,
                            colors.danger,
                            colors.purple
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 12, font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = total ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${value.toFixed(2)} ₴ (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });
        });

    fetch('{% url "api_profit_chart_data" %}')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('profitChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Прибуток (₴)',
                        data: data.data,
                        backgroundColor: colors.success,
                        borderColor: colors.success
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} ₴`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' ₴';
                                }
                            }
                        }
                    }
                }
            });
        });
});
</script>
{% endblock %}
