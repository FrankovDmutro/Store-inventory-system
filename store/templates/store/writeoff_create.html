{% extends 'store/base.html' %}

{% block title %}–ù–æ–≤–µ —Å–ø–∏—Å–∞–Ω–Ω—è{% endblock %}

{% block content %}
{% include 'store/partials/manager_nav.html' %}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">üìù –ù–æ–≤–µ —Å–ø–∏—Å–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É</h4>
                </div>
                <div class="card-body">
                    <form method="post" id="writeoffForm">
                        {% csrf_token %}
                        
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            <strong>–ü–æ–º–∏–ª–∫–∞!</strong>
                            <ul class="mb-0">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                    <li>{{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="{{ form.product.id_for_label }}" class="form-label fw-bold">
                                {{ form.product.label }}
                            </label>
                            {{ form.product }}
                            {% if form.product.errors %}
                                <div class="text-danger small">{{ form.product.errors }}</div>
                            {% endif %}
                            <div class="form-text">–í–∏–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä –¥–ª—è —Å–ø–∏—Å–∞–Ω–Ω—è</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.quantity.id_for_label }}" class="form-label fw-bold">
                                        {{ form.quantity.label }}
                                    </label>
                                    {{ form.quantity }}
                                    {% if form.quantity.errors %}
                                        <div class="text-danger small">{{ form.quantity.errors }}</div>
                                    {% endif %}
                                    <div id="availableQty" class="form-text"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.reason.id_for_label }}" class="form-label fw-bold">
                                        {{ form.reason.label }}
                                    </label>
                                    {{ form.reason }}
                                    {% if form.reason.errors %}
                                        <div class="text-danger small">{{ form.reason.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="{{ form.comment.id_for_label }}" class="form-label fw-bold">
                                {{ form.comment.label }}
                            </label>
                            {{ form.comment }}
                            {% if form.comment.errors %}
                                <div class="text-danger small">{{ form.comment.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è –£–≤–∞–≥–∞!</strong> –ü—ñ—Å–ª—è —Å–ø–∏—Å–∞–Ω–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—É –Ω–∞ —Å–∫–ª–∞–¥—ñ –±—É–¥–µ –∑–º–µ–Ω—à–µ–Ω–∞.
                            –¶—è –æ–ø–µ—Ä–∞—Ü—ñ—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ —Å–∫–∞—Å–æ–≤–∞–Ω–∞.
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'writeoffs_list' %}" class="btn btn-secondary">
                                ‚Üê –ù–∞–∑–∞–¥
                            </a>
                            <button type="submit" class="btn btn-danger btn-lg">
                                ‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —Å–ø–∏—Å–∞–Ω–Ω—è
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ü–æ–∫–∞–∑—É—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ —Ç–æ–≤–∞—Ä—É
document.getElementById('{{ form.product.id_for_label }}').addEventListener('change', function() {
    const productId = this.value;
    if (productId) {
        // –û—Ç—Ä–∏–º—É—î–º–æ —Ç–µ–∫—Å—Ç –æ–±—Ä–∞–Ω–æ–≥–æ option
        const selectedOption = this.options[this.selectedIndex];
        const productText = selectedOption.text;
        
        // –í–∏—Ç—è–≥—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑ —Ç–µ–∫—Å—Ç—É (–ø—Ä–∏–ø—É—Å–∫–∞—î–º–æ —Ñ–æ—Ä–º–∞—Ç "–ù–∞–∑–≤–∞ (X —à—Ç)")
        const match = productText.match(/\((\d+)\s*—à—Ç\)/);
        if (match) {
            const qty = match[1];
            document.getElementById('availableQty').innerHTML = 
                `<span class="badge bg-info">–î–æ—Å—Ç—É–ø–Ω–æ: ${qty} —à—Ç</span>`;
        }
    } else {
        document.getElementById('availableQty').innerHTML = '';
    }
});
</script>

{% endblock %}
